{% extends "base.html" %}
{% block title %}èŒä½çŸ¥è¯†å›¾è°±æµè§ˆ Â· AI æ±‚èŒçŸ¥è¯†å›¾è°±åŠ©æ‰‹{% endblock %}

{% block head_extra %}
<style>
    :root {
        --primary: #2563eb;
        --primary-hover: #1d4ed8;
        --primary-light: #e0f2fe;
        --secondary: #64748b;
        --success: #10b981;
        --warning: #f59e0b;
        --error: #ef4444;
        --background: #f8fafc;
        --surface: #ffffff;
        --border: #e2e8f0;
        --border-light: #f1f5f9;
        --text-primary: #1e293b;
        --text-secondary: #475569;
        --text-tertiary: #94a3b8;
        --radius-sm: 6px;
        --radius-md: 10px;
        --radius-lg: 12px;
        --radius-xl: 16px;
        --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
        --shadow-md: 0 4px 12px rgba(15, 23, 42, 0.08);
        --shadow-lg: 0 10px 25px rgba(15, 23, 42, 0.1);
        --transition: all 0.3s ease;
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        background-color: var(--background);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
        color: var(--text-primary);
        line-height: 1.6;
    }

    main {
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px 20px 60px;
    }

    /* ============== é¡µé¢å¤´éƒ¨ ============== */
    .page-header {
        margin-bottom: 32px;
    }

    .page-title-container {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
    }

    .page-title-section {
        flex: 1;
    }

    .step-indicator {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: rgba(37, 99, 235, 0.08);
        color: var(--primary);
        padding: 8px 16px;
        border-radius: var(--radius-md);
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 12px;
    }

    .step-indicator .step-number {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        background: var(--primary);
        color: white;
        border-radius: 50%;
        font-size: 12px;
    }

    .page-title {
        font-size: 32px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
        line-height: 1.3;
    }

    .page-subtitle {
        font-size: 16px;
        color: var(--text-secondary);
        max-width: 800px;
    }

    .stats-badge {
        background: white;
        border-radius: var(--radius-lg);
        padding: 16px 20px;
        box-shadow: var(--shadow-md);
        min-width: 180px;
        text-align: center;
    }

    .stats-value {
        font-size: 28px;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 4px;
    }

    .stats-label {
        font-size: 14px;
        color: var(--text-secondary);
        font-weight: 500;
    }

    /* ============== ä¸»å¸ƒå±€ ============== */
    .main-layout {
        display: grid;
        grid-template-columns: 1fr 1.8fr;
        gap: 24px;
        margin-top: 16px;
        align-items: stretch; /* ç¡®ä¿ä¸¤ä¸ªé¢æ¿æ‹‰ä¼¸å¯¹é½ */
    }

    @media (max-width: 1200px) {
        .main-layout {
            grid-template-columns: 1fr;
            gap: 20px;
        }
    }

    /* ============== å·¦ä¾§é¢æ¿ï¼šå²—ä½åˆ—è¡¨ ============== */
    .left-panel {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 200px);
        min-height: 600px;
        overflow: hidden;
    }

    .panel-card {
        background: var(--surface);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-md);
        padding: 24px;
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .panel-header {
        margin-bottom: 20px;
    }

    .panel-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 4px;
    }

    .panel-subtitle {
        font-size: 14px;
        color: var(--text-secondary);
    }

    /* æœç´¢åŒºåŸŸ */
    .search-container {
        margin-bottom: 20px;
        flex-shrink: 0;
    }

    .search-box {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
    }

    .search-input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 15px;
        color: var(--text-primary);
        transition: var(--transition);
        background: white;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
    }

    .search-button {
        padding: 12px 24px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        white-space: nowrap;
    }

    .search-button:hover {
        background: var(--primary-hover);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .search-hint {
        font-size: 13px;
        color: var(--text-tertiary);
        margin: 0;
    }

    .search-hint strong {
        color: var(--primary);
    }

    /* å²—ä½åˆ—è¡¨ */
    .job-list-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .job-list-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        flex-shrink: 0;
    }

    .job-count {
        font-size: 14px;
        color: var(--text-secondary);
        font-weight: 500;
    }

    .job-list {
        flex: 1;
        overflow-y: auto;
        padding-right: 12px;
    }

    .job-list::-webkit-scrollbar {
        width: 8px;
    }

    .job-list::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 10px;
    }

    .job-list::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
        border: 2px solid #f1f5f9;
    }

    .job-list::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    .job-item {
        display: block;
        padding: 16px;
        border-radius: var(--radius-lg);
        background: white;
        border: 1px solid var(--border-light);
        margin-bottom: 12px;
        text-decoration: none;
        color: var(--text-primary);
        transition: var(--transition);
        cursor: pointer;
    }

    .job-item:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .job-item.active {
        background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%);
        border-color: var(--primary);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
    }

    .job-item-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 8px;
    }

    .job-name {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        line-height: 1.4;
    }

    .job-item.active .job-name {
        color: #1e40af;
    }

    .job-badge {
        font-size: 11px;
        padding: 3px 8px;
        border-radius: 20px;
        font-weight: 600;
        white-space: nowrap;
    }

    .job-badge.city {
        background: #f1f5f9;
        color: var(--text-secondary);
    }

    .job-item.active .job-badge.city {
        background: white;
        color: var(--primary);
    }

    .job-meta {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 13px;
        color: var(--text-tertiary);
    }

    .job-meta-item {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    /* ============== å³ä¾§é¢æ¿ï¼šå²—ä½è¯¦æƒ… ============== */
    .right-panel {
        height: calc(100vh - 200px);
        overflow-y: auto;
        padding-right: 8px;
    }

    .right-panel-content {
        display: flex;
        flex-direction: column;
        gap: 24px;
        min-height: 100%;
    }

    .right-panel::-webkit-scrollbar {
        width: 6px;
    }

    .right-panel::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 10px;
    }

    .right-panel::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
    }

    /* å²—ä½æ ‡é¢˜å¡ç‰‡ */
    .job-title-card {
        background: var(--surface);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-md);
        padding: 28px;
        border-left: 6px solid var(--primary);
    }

    .job-title-main {
        font-size: 28px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
        line-height: 1.3;
    }

    .job-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 16px;
    }

    .tag {
        display: inline-flex;
        align-items: center;
        padding: 6px 14px;
        border-radius: var(--radius-md);
        font-size: 13px;
        font-weight: 600;
        background: white;
        border: 1px solid var(--border);
    }

    .tag.city {
        background: #f1f5f9;
        color: var(--text-secondary);
        border-color: #e2e8f0;
    }

    .tag.type {
        background: #e0f2fe;
        color: #0369a1;
        border-color: #bae6fd;
    }

    .tag.highlight {
        background: #fef3c7;
        color: #92400e;
        border-color: #fde68a;
    }

    /* è¯¦æƒ…å¡ç‰‡é€šç”¨æ ·å¼ */
    .detail-card {
        background: var(--surface);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-md);
        padding: 24px;
    }

    .detail-card-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
    }

    .detail-card-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        background: rgba(37, 99, 235, 0.1);
        color: var(--primary);
        border-radius: 10px;
        font-size: 18px;
    }

    .detail-card-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .detail-card-subtitle {
        font-size: 14px;
        color: var(--text-secondary);
        margin-top: 4px;
    }

    /* æŠ€èƒ½æ‘˜è¦å¡ç‰‡ */
    .skill-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .summary-item {
        background: #f8fafc;
        border-radius: var(--radius-lg);
        padding: 16px;
        border: 1px solid var(--border-light);
    }

    .summary-label {
        font-size: 13px;
        color: var(--text-secondary);
        margin-bottom: 8px;
        font-weight: 500;
    }

    .summary-value {
        font-size: 20px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .summary-value.primary {
        color: var(--primary);
    }

    .summary-value.success {
        color: var(--success);
    }

    .summary-value.warning {
        color: var(--warning);
    }

    /* æ ¸å¿ƒæŠ€èƒ½æ ‡ç­¾ */
    .core-skills {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 8px;
    }

    .core-skill-tag {
        padding: 8px 16px;
        background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%);
        color: #1e40af;
        border-radius: var(--radius-md);
        font-size: 14px;
        font-weight: 600;
        border: 1px solid rgba(147, 197, 253, 0.5);
        position: relative;
    }

    .core-skill-tag.rank-1::before {
        content: "ğŸ¥‡";
        margin-right: 6px;
    }

    .core-skill-tag.rank-2::before {
        content: "ğŸ¥ˆ";
        margin-right: 6px;
    }

    .core-skill-tag.rank-3::before {
        content: "ğŸ¥‰";
        margin-right: 6px;
    }

    /* æŠ€èƒ½è¡¨æ ¼ */
    .skills-table-container {
        overflow-x: auto;
    }

    .skills-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }

    .skills-table thead {
        background: #f8fafc;
    }

    .skills-table th {
        padding: 14px 16px;
        text-align: left;
        font-weight: 600;
        color: var(--text-secondary);
        border-bottom: 2px solid var(--border);
    }

    .skills-table tbody tr {
        border-bottom: 1px solid var(--border-light);
        transition: var(--transition);
    }

    .skills-table tbody tr:hover {
        background: #f8fafc;
    }

    .skills-table td {
        padding: 14px 16px;
        color: var(--text-primary);
    }

    .skill-name {
        font-weight: 500;
    }

    .skill-weight {
        font-weight: 600;
        color: var(--primary);
    }

    .skill-weight-bar {
        width: 100px;
        height: 6px;
        background: #e2e8f0;
        border-radius: 3px;
        overflow: hidden;
        margin-top: 4px;
    }

    .skill-weight-fill {
        height: 100%;
        background: var(--primary);
        border-radius: 3px;
    }

    /* çŸ¥è¯†å›¾è°±åŒºåŸŸ */
    .graph-container {
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        background: white;
        overflow: hidden;
        height: 400px;
        position: relative;
        min-height: 400px; /* æ·»åŠ æœ€å°é«˜åº¦ç¡®ä¿æ˜¾ç¤º */
    }

    #network {
        width: 100%;
        height: 100%;
        min-height: 400px;
    }

    /* è¯äº‘å®¹å™¨ */
    .word-cloud-container {
        height: 250px;
        position: relative;
        margin: 10px 0;
        overflow: hidden;
        border-radius: var(--radius-lg);
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border: 1px solid var(--border-light);
    }

    .word-cloud {
        width: 100%;
        height: 100%;
        position: relative;
    }

    .cloud-word {
        position: absolute;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        transform-origin: center center;
        text-align: center;
        will-change: transform, opacity;
    }

    .cloud-word:hover {
        transform: scale(1.3) !important;
        z-index: 1000;
        font-weight: bold !important;
    }

    /* è¯äº‘å›¾ä¾‹ */
    .word-cloud-legend {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 15px;
        flex-wrap: wrap;
    }

    .word-cloud-legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: var(--text-secondary);
    }

    .word-cloud-legend-color {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }

    /* çŸ¥è¯†å›¾è°±å›¾ä¾‹ */
    .graph-legend {
        margin-top: 20px;
        padding: 20px;
        background: #f8fafc;
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-light);
    }

    .graph-legend-title {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .graph-legend-content {
        display: flex;
        flex-wrap: wrap;
        gap: 30px;
    }

    .legend-left, .legend-right {
        flex: 1;
        min-width: 300px;
    }

    .legend-section {
        margin-bottom: 15px;
    }

    .legend-section-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 10px;
        padding-bottom: 5px;
        border-bottom: 1px solid var(--border-light);
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
        font-size: 13px;
        color: var(--text-secondary);
    }

    .legend-node {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 2px solid;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: bold;
        flex-shrink: 0;
    }

    .legend-job-node {
        background: #2563eb;
        border-color: #1d4ed8;
        color: white;
    }

    .legend-skill-node-high {
        background: #d1fae5;
        border-color: #10b981;
        color: #065f46;
    }

    .legend-skill-node-medium {
        background: #fef3c7;
        border-color: #f59e0b;
        color: #92400e;
    }

    .legend-skill-node-low {
        background: #e0f2fe;
        border-color: #3b82f6;
        color: #1e40af;
    }

    .legend-edge {
        height: 4px;
        border-radius: 2px;
        margin: 0 5px;
    }

    .legend-edge-high {
        background: #10b981;
        width: 40px;
    }

    .legend-edge-medium {
        background: #f59e0b;
        width: 25px;
    }

    .legend-edge-low {
        background: #3b82f6;
        width: 15px;
    }

    .legend-size-demo {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 10px;
    }

    .legend-size-circle {
        border-radius: 50%;
        background: #e0f2fe;
        border: 2px solid #3b82f6;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        color: #1e40af;
        font-weight: bold;
    }

    .legend-size-small {
        width: 20px;
        height: 20px;
    }

    .legend-size-medium {
        width: 30px;
        height: 30px;
    }

    .legend-size-large {
        width: 40px;
        height: 40px;
    }

    /* ç©ºçŠ¶æ€ */
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 60px 20px;
        color: var(--text-tertiary);
        height: 100%;
    }

    .empty-state-icon {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.5;
    }

    .empty-state-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 8px;
    }

    .empty-state-description {
        font-size: 15px;
        max-width: 400px;
        margin: 0 auto;
        line-height: 1.6;
    }

    /* çŸ¥è¯†å›¾è°±æ§åˆ¶é¢æ¿ */
    .graph-controls {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
    }

    .graph-control-btn {
        padding: 8px 16px;
        background: white;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 13px;
        color: var(--text-secondary);
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .graph-control-btn:hover {
        background: var(--background);
        border-color: var(--primary);
        color: var(--primary);
    }

    /* ============== å“åº”å¼è®¾è®¡ ============== */
    @media (max-width: 1200px) {
        .page-title-container {
            flex-direction: column;
            gap: 20px;
        }

        .stats-badge {
            width: 100%;
            max-width: 300px;
        }

        .left-panel {
            height: auto;
            min-height: 500px;
        }

        .right-panel {
            height: auto;
            overflow-y: visible;
        }

        .right-panel-content {
            min-height: auto;
        }
    }

    @media (max-width: 768px) {
        main {
            padding: 16px 16px 40px;
        }

        .page-title {
            font-size: 26px;
        }

        .panel-card, .detail-card, .job-title-card {
            padding: 20px;
        }

        .job-title-main {
            font-size: 24px;
        }

        .skill-summary {
            grid-template-columns: 1fr;
        }

        .graph-container {
            height: 300px;
            min-height: 300px;
        }

        .word-cloud-legend {
            gap: 10px;
        }

        .graph-legend-content {
            flex-direction: column;
            gap: 20px;
        }

        .legend-left, .legend-right {
            min-width: 100%;
        }
    }

    @media (max-width: 480px) {
        .page-title {
            font-size: 22px;
        }

        .search-box {
            flex-direction: column;
        }

        .search-button {
            width: 100%;
        }

        .panel-card, .detail-card, .job-title-card {
            padding: 16px;
        }

        .job-title-main {
            font-size: 20px;
        }

        .detail-card-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }
    }
</style>
<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
{% endblock %}

{% block content %}
<main>
    <!-- é¡µé¢å¤´éƒ¨ -->
    <div class="page-header">
        <div class="step-indicator">
            <div class="step-number">1</div>
            <span>æ¢ç´¢å²—ä½çŸ¥è¯†å›¾è°±</span>
        </div>

        <div class="page-title-container">
            <div class="page-title-section">
                <h1 class="page-title">èŒä½çŸ¥è¯†å›¾è°±æ¢ç´¢</h1>
                <p class="page-subtitle">
                    æ·±å…¥åˆ†æå²—ä½æŠ€èƒ½ç»“æ„ï¼Œå¯è§†åŒ–å²—ä½-æŠ€èƒ½å…³ç³»ç½‘ç»œã€‚é€‰æ‹©å·¦ä¾§å²—ä½æŸ¥çœ‹è¯¦ç»†æŠ€èƒ½ç”»åƒå’ŒçŸ¥è¯†å›¾è°±ã€‚
                </p>
            </div>

            <div class="stats-badge">
                <div class="stats-value">{{ jobs|length }}</div>
                <div class="stats-label">ä¸ªå²—ä½å¯æ¢ç´¢</div>
            </div>
        </div>
    </div>

    <!-- ä¸»å¸ƒå±€ -->
    <div class="main-layout">
        <!-- å·¦ä¾§ï¼šå²—ä½åˆ—è¡¨ -->
        <div class="left-panel">
            <div class="panel-card">
                <div class="panel-header">
                    <h2 class="panel-title">
                        <span class="icon">ğŸ”</span>
                        å²—ä½æœç´¢ä¸ç­›é€‰
                    </h2>
                    <p class="panel-subtitle">æŒ‰å²—ä½åç§°ã€æŠ€èƒ½æˆ–åŸå¸‚è¿›è¡Œæœç´¢</p>
                </div>

                <div class="search-container">
                    <form class="search-box" method="get" action="{{ url_for('explore_page') }}">
                        <input
                            type="text"
                            name="q"
                            class="search-input"
                            placeholder="æœç´¢å²—ä½åç§°ã€æŠ€èƒ½æˆ–åŸå¸‚..."
                            value="{{ q or '' }}"
                        >
                        <button type="submit" class="search-button">æœç´¢</button>
                    </form>

                    <p class="search-hint">
                        {% if q %}
                            æœç´¢å…³é”®è¯: <strong>"{{ q }}"</strong> Â·
                        {% endif %}
                        æ”¯æŒæ¨¡ç³Šæœç´¢ï¼Œå¦‚"æ•°æ® åˆ†æ"ã€"åŒ—äº¬ å¼€å‘"
                    </p>
                </div>

                <div class="job-list-container">
                    <div class="job-list-header">
                        <h3 class="panel-title" style="font-size:16px; margin-bottom:0;">
                            <span class="icon">ğŸ“‹</span>
                            å²—ä½åˆ—è¡¨
                        </h3>
                        <div class="job-count">{{ jobs|length }} ä¸ªå²—ä½</div>
                    </div>

                    <div class="job-list">
                        {% if jobs %}
                            {% for j in jobs %}
                                <a class="job-item {% if selected_job and selected_job.id == j.id %}active{% endif %}"
                                   href="{{ url_for('explore_page') }}?q={{ q|urlencode }}&job_id={{ j.id }}">
                                    <div class="job-item-header">
                                        <div class="job-name">{{ j.name or 'æœªå‘½åå²—ä½' }}</div>
                                        <div class="job-badge city">{{ j.city or 'æœªçŸ¥åŸå¸‚' }}</div>
                                    </div>
                                    <div class="job-meta">
                                        <!-- ç§»é™¤äº†æŠ€èƒ½æ•°é‡æ˜¾ç¤º -->
                                        <div class="job-meta-item">
                                            <span class="icon">ğŸ“</span>
                                            <span>{{ j.type if j.type else 'å…¨èŒ' }}</span>
                                        </div>
                                    </div>
                                </a>
                            {% endfor %}
                        {% else %}
                            <div class="empty-state" style="padding: 40px 20px;">
                                <div class="empty-state-icon">ğŸ”</div>
                                <div class="empty-state-title">æœªæ‰¾åˆ°ç›¸å…³å²—ä½</div>
                                <div class="empty-state-description">
                                    å°è¯•ä½¿ç”¨å…¶ä»–å…³é”®è¯æœç´¢ï¼Œæˆ–æŸ¥çœ‹æ‰€æœ‰å²—ä½ã€‚
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šå²—ä½è¯¦æƒ… -->
        <div class="right-panel">
            <div class="right-panel-content">
                {% if selected_job and job_skills %}
                    <!-- å²—ä½æ ‡é¢˜å¡ç‰‡ -->
                    <div class="job-title-card">
                        <div class="job-title-main">{{ selected_job.name }}</div>

                        <div class="job-tags">
                            <span class="tag city">{{ selected_job.city or 'æœªçŸ¥åŸå¸‚' }}</span>

                            {% if 'æ•°æ®' in selected_job.name %}
                                <span class="tag type">æ•°æ®ç±»å²—ä½</span>
                            {% elif 'ç®—æ³•' in selected_job.name %}
                                <span class="tag type">AI / ç®—æ³•</span>
                            {% elif 'å‰ç«¯' in selected_job.name %}
                                <span class="tag type">å‰ç«¯å¼€å‘</span>
                            {% elif 'åç«¯' in selected_job.name %}
                                <span class="tag type">åç«¯å¼€å‘</span>
                            {% elif 'äº§å“' in selected_job.name %}
                                <span class="tag type">äº§å“æ–¹å‘</span>
                            {% else %}
                                <span class="tag type">ç»¼åˆå²—ä½</span>
                            {% endif %}

                            {% if job_skills|length > 8 %}
                                <span class="tag highlight">æŠ€èƒ½ä¸°å¯Œ</span>
                            {% endif %}

                            <span class="tag">{{ job_skills|length }} é¡¹æŠ€èƒ½</span>
                        </div>
                    </div>

                    {% set sorted_skills = job_skills|sort(attribute='weight', reverse=True) %}
                    {% set top3 = sorted_skills[:3] %}
                    {% set total_w = sorted_skills|map(attribute='weight')|sum %}
                    {% set top3_w = top3|map(attribute='weight')|sum %}
                    {% set concentration = (top3_w/total_w*100) if total_w>0 else 0 %}

                    <!-- æŠ€èƒ½æ‘˜è¦å¡ç‰‡ -->
                    <div class="detail-card">
                        <div class="detail-card-header">
                            <div class="detail-card-icon">ğŸ¯</div>
                            <div>
                                <h3 class="detail-card-title">å²—ä½æŠ€èƒ½ç”»åƒ</h3>
                                <p class="detail-card-subtitle">æ ¸å¿ƒæŠ€èƒ½åˆ†å¸ƒä¸æƒé‡åˆ†æ</p>
                            </div>
                        </div>

                        <div class="skill-summary">
                            <div class="summary-item">
                                <div class="summary-label">æŠ€èƒ½æ€»æ•°</div>
                                <div class="summary-value primary">{{ job_skills|length }}</div>
                            </div>

                            <div class="summary-item">
                                <div class="summary-label">æŠ€èƒ½é›†ä¸­åº¦</div>
                                <div class="summary-value {{ 'success' if concentration >= 70 else 'warning' if concentration >= 45 else 'primary' }}">
                                    {{ "%.1f"|format(concentration) }}%
                                </div>
                                <div class="summary-label">
                                    {% if concentration >= 70 %}
                                        é«˜åº¦é›†ä¸­ Â· æ ¸å¿ƒæ˜ç¡®
                                    {% elif concentration >= 45 %}
                                        ä¸­ç­‰é›†ä¸­ Â· å…¨é¢å‘å±•
                                    {% else %}
                                        è¾ƒä¸ºå‡è¡¡ Â· å¹¿åº¦é‡è¦
                                    {% endif %}
                            </div>
                            </div>

                            <div class="summary-item">
                                <div class="summary-label">æœ€é«˜æƒé‡æŠ€èƒ½</div>
                                <div class="summary-value">{{ top3[0].skill if top3 else 'N/A' }}</div>
                                <div class="summary-label">æƒé‡: {{ "%.2f"|format(top3[0].weight) if top3 else '0.00' }}</div>
                            </div>
                        </div>

                        <div>
                            <div class="summary-label" style="margin-bottom:12px;">æ ¸å¿ƒæŠ€èƒ½ï¼ˆå‰ä¸‰ï¼‰</div>
                            <div class="core-skills">
                                {% for skill in top3 %}
                                    <div class="core-skill-tag rank-{{ loop.index }}">
                                        {{ skill.skill }}
                                        <span style="margin-left:6px; font-weight:500; opacity:0.8;">
                                            {{ "%.2f"|format(skill.weight) }}
                                        </span>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- è¯äº‘å¡ç‰‡ -->
                    <div class="detail-card">
                        <div class="detail-card-header">
                            <div class="detail-card-icon">â˜ï¸</div>
                            <div>
                                <h3 class="detail-card-title">æŠ€èƒ½è¯äº‘</h3>
                                <p class="detail-card-subtitle">æŠ€èƒ½æƒé‡å¯è§†åŒ–ï¼Œè¶Šå¤§è¶Šé‡è¦</p>
                            </div>
                        </div>

                        <div class="word-cloud-container">
                            <div class="word-cloud" id="word-cloud"></div>
                        </div>

                        <!-- è¯äº‘å›¾ä¾‹ -->
                        <div class="word-cloud-legend">
                            <div class="word-cloud-legend-item">
                                <div class="word-cloud-legend-color" style="background: #059669;"></div>
                                <span>æ ¸å¿ƒæŠ€èƒ½ (â‰¥0.7)</span>
                            </div>
                            <div class="word-cloud-legend-item">
                                <div class="word-cloud-legend-color" style="background: #d97706;"></div>
                                <span>é‡è¦æŠ€èƒ½ (0.4-0.7)</span>
                            </div>
                            <div class="word-cloud-legend-item">
                                <div class="word-cloud-legend-color" style="background: #2563eb;"></div>
                                <span>ä¸€èˆ¬æŠ€èƒ½ (â‰¤0.4)</span>
                            </div>
                        </div>

                        <div style="font-size: 12px; color: var(--text-tertiary); margin-top: 10px; text-align: center;">
                            æç¤ºï¼šé¼ æ ‡æ‚¬åœæŸ¥çœ‹æŠ€èƒ½è¯¦æƒ…ï¼Œå­—ä½“å¤§å°è¡¨ç¤ºæƒé‡
                        </div>
                    </div>

                    <!-- æŠ€èƒ½è¡¨æ ¼å¡ç‰‡ -->
                    <div class="detail-card">
                        <div class="detail-card-header">
                            <div class="detail-card-icon">ğŸ“‹</div>
                            <div>
                                <h3 class="detail-card-title">æŠ€èƒ½æ¸…å•</h3>
                                <p class="detail-card-subtitle">æŒ‰æƒé‡æ’åºçš„å®Œæ•´æŠ€èƒ½åˆ—è¡¨</p>
                            </div>
                        </div>

                        <div class="skills-table-container">
                            <table class="skills-table">
                                <thead>
                                    <tr>
                                        <th style="width:5%;">æ’å</th>
                                        <th style="width:65%;">æŠ€èƒ½åç§°</th>
                                        <th style="width:15%;">æƒé‡</th>
                                        <th style="width:15%;">å æ¯”</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in sorted_skills %}
                                        <tr>
                                            <td>
                                                <div style="
                                                    display: inline-flex;
                                                    align-items: center;
                                                    justify-content: center;
                                                    width: 24px;
                                                    height: 24px;
                                                    background: {{ '#fef3c7' if loop.index0 < 3 else '#f1f5f9' }};
                                                    color: {{ '#92400e' if loop.index0 < 3 else '#64748b' }};
                                                    border-radius: 50%;
                                                    font-weight: 600;
                                                    font-size: 12px;
                                                ">
                                                    {{ loop.index }}
                                                </div>
                                            </td>
                                            <td class="skill-name">{{ item.skill }}</td>
                                            <td class="skill-weight">{{ "%.2f"|format(item.weight) }}</td>
                                            <td>
                                                <div>{{ "%.1f"|format(item.weight/total_w*100 if total_w>0 else 0) }}%</div>
                                                <div class="skill-weight-bar">
                                                    <div class="skill-weight-fill" style="width: {{ (item.weight/top3[0].weight*100 if top3 else 0) }}%"></div>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- çŸ¥è¯†å›¾è°±å¡ç‰‡ -->
                    <div class="detail-card">
                        <div class="detail-card-header">
                            <div class="detail-card-icon">ğŸŒ</div>
                            <div>
                                <h3 class="detail-card-title">çŸ¥è¯†å›¾è°±ç½‘ç»œ</h3>
                                <p class="detail-card-subtitle">å²—ä½-æŠ€èƒ½å…³ç³»å¯è§†åŒ–ç½‘ç»œ</p>
                            </div>
                        </div>

                        <div class="graph-container">
                            <div id="network"></div>
                        </div>

                        <div class="graph-controls">
                            <button class="graph-control-btn" onclick="graph.fit()">
                                <span>ğŸ”</span> é‡ç½®è§†å›¾
                            </button>
                            <button class="graph-control-btn" onclick="togglePhysics()">
                                <span>âš™ï¸</span> åˆ‡æ¢ç‰©ç†æ•ˆæœ
                            </button>
                            <div style="font-size: 12px; color: var(--text-tertiary); margin-left: auto;">
                                æç¤ºï¼šæ‹–æ‹½èŠ‚ç‚¹ã€æ»šè½®ç¼©æ”¾ã€ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…
                            </div>
                        </div>

                        <!-- çŸ¥è¯†å›¾è°±å›¾ä¾‹ - è°ƒæ•´å¸ƒå±€ -->
                        <div class="graph-legend">
                            <div class="graph-legend-title">
                                <span>ğŸ“Š</span> å›¾ä¾‹è¯´æ˜
                            </div>

                            <div class="graph-legend-content">
                                <!-- å·¦ä¾§ï¼šèŠ‚ç‚¹é¢œè‰² -->
                                <div class="legend-left">
                                    <div class="legend-section">
                                        <div class="legend-section-title">èŠ‚ç‚¹é¢œè‰²</div>
                                        <div class="legend-item">
                                            <div class="legend-node legend-job-node">å²—</div>
                                            <span>å²—ä½èŠ‚ç‚¹ï¼ˆè“è‰²ï¼‰</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-node legend-skill-node-high">é«˜</div>
                                            <span>æ ¸å¿ƒæŠ€èƒ½ï¼ˆç»¿è‰²ï¼‰æƒé‡â‰¥0.7</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-node legend-skill-node-medium">ä¸­</div>
                                            <span>é‡è¦æŠ€èƒ½ï¼ˆé»„è‰²ï¼‰0.4â‰¤æƒé‡&lt;0.7</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-node legend-skill-node-low">ä½</div>
                                            <span>ä¸€èˆ¬æŠ€èƒ½ï¼ˆè“è‰²ï¼‰æƒé‡&lt;0.4</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- å³ä¾§ï¼šèŠ‚ç‚¹å¤§å°å’Œè¿æ¥çº¿ç²—ç»† -->
                                <div class="legend-right">
                                    <div class="legend-section">
                                        <div class="legend-section-title">èŠ‚ç‚¹å¤§å°</div>
                                        <div class="legend-item">
                                            <div class="legend-size-demo">
                                                <div class="legend-size-circle legend-size-small">å°</div>
                                                <span>æƒé‡å°</span>
                                                <div class="legend-size-circle legend-size-medium">ä¸­</div>
                                                <span>æƒé‡ä¸­</span>
                                                <div class="legend-size-circle legend-size-large">å¤§</div>
                                                <span>æƒé‡å¤§</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="legend-section">
                                        <div class="legend-section-title">è¿æ¥çº¿ç²—ç»†</div>
                                        <div class="legend-item">
                                            <div class="legend-edge legend-edge-high"></div>
                                            <span>å¼ºå…³è”ï¼ˆæƒé‡â‰¥0.7ï¼‰</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-edge legend-edge-medium"></div>
                                            <span>ä¸­ç­‰å…³è”ï¼ˆ0.4â‰¤æƒé‡&lt;0.7ï¼‰</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-edge legend-edge-low"></div>
                                            <span>å¼±å…³è”ï¼ˆæƒé‡&lt;0.4ï¼‰</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <!-- ç©ºçŠ¶æ€ï¼šæœªé€‰æ‹©å²—ä½ -->
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ”</div>
                        <div class="empty-state-title">é€‰æ‹©ä¸€ä¸ªå²—ä½å¼€å§‹æ¢ç´¢</div>
                        <div class="empty-state-description">
                            åœ¨å·¦ä¾§é€‰æ‹©ä¸€ä¸ªå²—ä½ï¼Œè¿™é‡Œå°†æ˜¾ç¤ºè¯¥å²—ä½çš„è¯¦ç»†æŠ€èƒ½ç”»åƒã€æ ¸å¿ƒè¦æ±‚åˆ†æä»¥åŠå²—ä½-æŠ€èƒ½çŸ¥è¯†å›¾è°±ç½‘ç»œã€‚
                        </div>
                        <div style="margin-top: 24px; display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;">
                            <div class="tag" style="background: #f0f9ff; padding: 10px 16px;">
                                <span style="font-weight: 700; color: #0369a1;">ğŸ’¡ æç¤ºï¼š</span>
                                ç‚¹å‡»å·¦ä¾§å²—ä½æŸ¥çœ‹è¯¦æƒ…
                            </div>
                            <div class="tag" style="background: #f0f9ff; padding: 10px 16px;">
                                <span style="font-weight: 700; color: #0369a1;">ğŸ¯ åŠŸèƒ½ï¼š</span>
                                æŠ€èƒ½åˆ†æã€æƒé‡æ’åºã€å›¾è°±å¯è§†åŒ–
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block scripts %}
{% if selected_job and job_skills %}
<script>
// è¯äº‘ç”Ÿæˆå‡½æ•° - æ”¹è¿›ç‰ˆï¼Œè®©è¯æ›´å±…ä¸­
function generateWordCloud(skillsData) {
    const container = document.getElementById('word-cloud');
    if (!container) return;

    container.innerHTML = '';

    // æŒ‰æƒé‡æ’åº
    const sortedSkills = skillsData.sort((a, b) => b.weight - a.weight);

    // é™åˆ¶æ˜¾ç¤ºæ•°é‡ï¼Œé¿å…æ‹¥æŒ¤
    const displayCount = Math.min(25, sortedSkills.length);
    const displaySkills = sortedSkills.slice(0, displayCount);

    // è·å–æƒé‡èŒƒå›´
    const weights = displaySkills.map(s => s.weight);
    const maxWeight = Math.max(...weights);
    const minWeight = Math.min(...weights);
    const weightRange = maxWeight - minWeight;

    // å®¹å™¨å°ºå¯¸
    const width = container.clientWidth;
    const height = container.clientHeight;
    const centerX = width / 2;
    const centerY = height / 2;

    // ç”¨äºè®°å½•å·²æ”¾ç½®è¯çš„ä½ç½®
    const placedWords = [];

    // åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿç½‘æ ¼æ¥ç®¡ç†ä½ç½®
    const gridSize = 20;
    const grid = Array(Math.ceil(width / gridSize)).fill().map(() =>
        Array(Math.ceil(height / gridSize)).fill(false)
    );

    // æ ‡è®°ä¸­å¿ƒåŒºåŸŸä¸ºå·²å ç”¨ï¼ˆé˜²æ­¢è¯é‡å åœ¨ä¸­å¿ƒï¼‰
    const centerGridX = Math.floor(centerX / gridSize);
    const centerGridY = Math.floor(centerY / gridSize);
    const centerRadius = 2; // ä¸­å¿ƒåŒºåŸŸåŠå¾„

    for (let dx = -centerRadius; dx <= centerRadius; dx++) {
        for (let dy = -centerRadius; dy <= centerRadius; dy++) {
            const x = centerGridX + dx;
            const y = centerGridY + dy;
            if (x >= 0 && x < grid.length && y >= 0 && y < grid[0].length) {
                grid[x][y] = true;
            }
        }
    }

    displaySkills.forEach((skill, index) => {
        const normalizedWeight = (skill.weight - minWeight) / (weightRange || 1);

        // å­—ä½“å¤§å°åŸºäºæƒé‡å’Œæ’åï¼ˆæ’åè¶Šé å‰å­—ä½“è¶Šå¤§ï¼‰
        const rankFactor = Math.max(0.5, 1 - index / displaySkills.length);
        const fontSize = 16 + normalizedWeight * 30 * rankFactor;

        // é¢œè‰²åŸºäºæƒé‡
        let color;
        if (normalizedWeight > 0.7) {
            color = '#059669'; // æ·±ç»¿è‰²
        } else if (normalizedWeight > 0.4) {
            color = '#d97706'; // æ©™è‰²
        } else {
            color = '#2563eb'; // è“è‰²
        }

        // æƒé‡è¶Šé«˜çš„è¯è¶Šé è¿‘ä¸­å¿ƒ
        const centerBias = 1 - normalizedWeight * 0.7; // 0.3åˆ°1.0çš„åå·®ç³»æ•°

        // å°è¯•æ”¾ç½®å•è¯
        let placed = false;
        let attempts = 0;
        const maxAttempts = 200;

        while (!placed && attempts < maxAttempts) {
            // è®¡ç®—ä½ç½® - ä½¿ç”¨æåæ ‡ï¼Œè®©è¯æ›´å±…ä¸­
            let radius, angle;

            // æ ¹æ®æƒé‡å†³å®šè·ç¦»ä¸­å¿ƒçš„è·ç¦»ï¼ˆæƒé‡è¶Šé«˜è¶Šé è¿‘ä¸­å¿ƒï¼‰
            const maxRadius = Math.min(width, height) * 0.4;
            const minRadius = Math.min(width, height) * 0.05;

            // æƒé‡é«˜çš„è¯æ›´é è¿‘ä¸­å¿ƒ
            radius = minRadius + (maxRadius - minRadius) * centerBias * Math.sqrt(Math.random());
            angle = Math.random() * 2 * Math.PI;

            // è®¡ç®—åæ ‡
            let x = centerX + radius * Math.cos(angle);
            let y = centerY + radius * Math.sin(angle);

            // ç¡®ä¿åœ¨è¾¹ç•Œå†…
            const padding = fontSize * 1.2;
            if (x < padding || x > width - padding ||
                y < padding || y > height - padding) {
                attempts++;
                continue;
            }

            // æ£€æŸ¥ç½‘æ ¼å ç”¨æƒ…å†µ
            const gridX = Math.floor(x / gridSize);
            const gridY = Math.floor(y / gridSize);
            const gridRadius = Math.ceil(fontSize / gridSize / 2) + 1;

            let gridOccupied = false;
            for (let dx = -gridRadius; dx <= gridRadius && !gridOccupied; dx++) {
                for (let dy = -gridRadius; dy <= gridRadius && !gridOccupied; dy++) {
                    const checkX = gridX + dx;
                    const checkY = gridY + dy;
                    if (checkX >= 0 && checkX < grid.length &&
                        checkY >= 0 && checkY < grid[0].length &&
                        grid[checkX][checkY]) {
                        gridOccupied = true;
                    }
                }
            }

            if (!gridOccupied) {
                // éšæœºæ—‹è½¬è§’åº¦ï¼ˆ-20åˆ°20åº¦ï¼‰
                const rotation = (Math.random() - 0.5) * 40;

                const wordElement = document.createElement('div');
                wordElement.className = 'cloud-word';
                wordElement.textContent = skill.skill;
                wordElement.title = `${skill.skill}\næƒé‡: ${skill.weight.toFixed(2)}\næ’å: ${index + 1}`;

                // è®¾ç½®æ ·å¼
                wordElement.style.fontSize = `${fontSize}px`;
                wordElement.style.color = color;
                wordElement.style.fontWeight = normalizedWeight > 0.6 ? 'bold' : '600';
                wordElement.style.opacity = 0.85 + normalizedWeight * 0.15;
                wordElement.style.textShadow = '1px 1px 3px rgba(0,0,0,0.1)';
                wordElement.style.transform = `translate(-50%, -50%) rotate(${rotation}deg)`;
                wordElement.style.left = `${x}px`;
                wordElement.style.top = `${y}px`;
                wordElement.style.zIndex = Math.floor(1000 * normalizedWeight);

                container.appendChild(wordElement);

                // æ ‡è®°ç½‘æ ¼ä¸ºå·²å ç”¨
                for (let dx = -gridRadius; dx <= gridRadius; dx++) {
                    for (let dy = -gridRadius; dy <= gridRadius; dy++) {
                        const markX = gridX + dx;
                        const markY = gridY + dy;
                        if (markX >= 0 && markX < grid.length &&
                            markY >= 0 && markY < grid[0].length) {
                            grid[markX][markY] = true;
                        }
                    }
                }

                // è®°å½•å·²æ”¾ç½®çš„è¯
                placedWords.push({
                    x, y,
                    size: fontSize,
                    element: wordElement,
                    weight: skill.weight
                });

                // æ·»åŠ æ‚¬åœæ•ˆæœ
                wordElement.addEventListener('mouseenter', function() {
                    this.style.opacity = '1';
                    this.style.textShadow = '2px 2px 6px rgba(0,0,0,0.2)';
                    this.style.zIndex = '10000';
                });

                wordElement.addEventListener('mouseleave', function() {
                    this.style.opacity = 0.85 + normalizedWeight * 0.15;
                    this.style.textShadow = '1px 1px 3px rgba(0,0,0,0.1)';
                    this.style.zIndex = Math.floor(1000 * normalizedWeight);
                });

                placed = true;
            }

            attempts++;
        }

        // å¦‚æœæ”¾ç½®å¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶æ”¾ç½®
        if (!placed && attempts >= maxAttempts) {
            console.log(`æ— æ³•æ”¾ç½®è¯: ${skill.skill}, å°è¯•å¼ºåˆ¶æ”¾ç½®`);
            // ç®€å•æ”¾ç½®åœ¨æœ€åˆé€‚çš„ä½ç½®
            const fontSize = 16 + normalizedWeight * 25;
            const x = centerX + (Math.random() - 0.5) * width * 0.6;
            const y = centerY + (Math.random() - 0.5) * height * 0.6;
            const rotation = (Math.random() - 0.5) * 30;

            const wordElement = document.createElement('div');
            wordElement.className = 'cloud-word';
            wordElement.textContent = skill.skill;
            wordElement.title = `${skill.skill}\næƒé‡: ${skill.weight.toFixed(2)}\næ’å: ${index + 1}`;

            wordElement.style.fontSize = `${fontSize}px`;
            wordElement.style.color = color;
            wordElement.style.fontWeight = normalizedWeight > 0.6 ? 'bold' : '600';
            wordElement.style.opacity = 0.8;
            wordElement.style.textShadow = '1px 1px 3px rgba(0,0,0,0.1)';
            wordElement.style.transform = `translate(-50%, -50%) rotate(${rotation}deg)`;
            wordElement.style.left = `${x}px`;
            wordElement.style.top = `${y}px`;
            wordElement.style.zIndex = Math.floor(1000 * normalizedWeight);

            container.appendChild(wordElement);
        }
    });
}

// å…¨å±€å˜é‡å­˜å‚¨ç½‘ç»œå®ä¾‹
let graph = null;
let physicsEnabled = true;

// ç”ŸæˆçŸ¥è¯†å›¾è°±
function generateKnowledgeGraph(skillsData, jobName) {
    const container = document.getElementById('network');
    if (!container) {
        console.error('çŸ¥è¯†å›¾è°±å®¹å™¨æœªæ‰¾åˆ°');
        return;
    }

    // æ¸…ç©ºå®¹å™¨
    container.innerHTML = '';

    // åˆ›å»ºèŠ‚ç‚¹æ•°æ®
    const nodes = new vis.DataSet();
    const edges = new vis.DataSet();

    // æ·»åŠ å²—ä½èŠ‚ç‚¹
    nodes.add({
        id: 0,
        label: jobName,
        shape: 'box',
        color: {
            background: '#2563eb',
            border: '#1d4ed8',
            highlight: {
                background: '#1d4ed8',
                border: '#1e40af'
            }
        },
        font: {
            color: '#ffffff',
            size: 20,
            bold: true
        },
        size: 40,
        shadow: {
            enabled: true,
            color: 'rgba(37, 99, 235, 0.5)',
            size: 10
        },
        borderWidth: 2,
        margin: 10
    });

    // è·å–æœ€å¤§æƒé‡
    const maxWeight = Math.max(...skillsData.map(s => s.weight || 0));

    // æ·»åŠ æŠ€èƒ½èŠ‚ç‚¹å’Œè¾¹
    skillsData.forEach((skill, index) => {
        const nodeId = index + 1;
        const normalizedWeight = skill.weight / maxWeight;

        // æ ¹æ®æƒé‡ç¡®å®šèŠ‚ç‚¹å¤§å°
        const nodeSize = 20 + normalizedWeight * 35;

        // æ ¹æ®æƒé‡ç¡®å®šèŠ‚ç‚¹é¢œè‰²
        let nodeColor;
        if (normalizedWeight > 0.7) {
            nodeColor = {
                background: '#d1fae5',
                border: '#10b981',
                highlight: {
                    background: '#a7f3d0',
                    border: '#059669'
                }
            };
        } else if (normalizedWeight > 0.4) {
            nodeColor = {
                background: '#fef3c7',
                border: '#f59e0b',
                highlight: {
                    background: '#fde68a',
                    border: '#d97706'
                }
            };
        } else {
            nodeColor = {
                background: '#e0f2fe',
                border: '#3b82f6',
                highlight: {
                    background: '#bae6fd',
                    border: '#2563eb'
                }
            };
        }

        // æ·»åŠ æŠ€èƒ½èŠ‚ç‚¹
        nodes.add({
            id: nodeId,
            label: skill.skill,
            shape: 'dot',
            size: nodeSize,
            color: nodeColor,
            font: {
                size: 14 + normalizedWeight * 10,
                color: '#1e293b',
                bold: normalizedWeight > 0.5,
                face: 'sans-serif'
            },
            shadow: {
                enabled: true,
                color: 'rgba(0,0,0,0.1)',
                size: 5
            },
            borderWidth: 2,
            title: `${skill.skill}\næƒé‡: ${skill.weight.toFixed(2)}\nå æ¯”: ${((skill.weight/maxWeight)*100).toFixed(1)}%`
        });

        // æ·»åŠ è¾¹
        const edgeWidth = 1 + normalizedWeight * 4;
        let edgeColor;
        if (normalizedWeight > 0.7) {
            edgeColor = '#10b981';
        } else if (normalizedWeight > 0.4) {
            edgeColor = '#f59e0b';
        } else {
            edgeColor = '#3b82f6';
        }

        edges.add({
            from: 0,
            to: nodeId,
            width: edgeWidth,
            color: {
                color: edgeColor,
                highlight: '#2563eb',
                opacity: 0.7
            },
            smooth: {
                type: 'continuous',
                roundness: 0.3
            },
            arrows: {
                to: {
                    enabled: true,
                    scaleFactor: 0.7,
                    type: 'arrow'
                }
            },
            shadow: {
                enabled: true,
                color: 'rgba(0,0,0,0.1)',
                size: 3
            },
            title: `å…³è”å¼ºåº¦: ${skill.weight.toFixed(2)}`
        });
    });

    // å®šä¹‰ç½‘ç»œé€‰é¡¹
    const options = {
        nodes: {
            borderWidth: 2,
            borderWidthSelected: 4,
            shadow: {
                enabled: true,
                size: 5
            },
            shapeProperties: {
                useBorderWithImage: true
            },
            scaling: {
                min: 10,
                max: 60,
                label: {
                    enabled: true,
                    min: 8,
                    max: 30
                }
            }
        },
        edges: {
            smooth: {
                type: 'continuous',
                roundness: 0.3
            },
            selectionWidth: 2,
            shadow: {
                enabled: true
            },
            arrows: {
                to: {
                    enabled: true
                }
            },
            color: {
                inherit: false
            }
        },
        physics: {
            enabled: true,
            stabilization: {
                enabled: true,
                iterations: 500,
                updateInterval: 25
            },
            barnesHut: {
                gravitationalConstant: -2000,
                centralGravity: 0.3,
                springLength: 200,
                springConstant: 0.04,
                damping: 0.09,
                avoidOverlap: 1
            },
            solver: 'barnesHut'
        },
        interaction: {
            hover: true,
            hoverConnectedEdges: true,
            selectable: true,
            selectConnectedEdges: true,
            navigationButtons: true,
            keyboard: {
                enabled: true,
                speed: {
                    x: 10,
                    y: 10,
                    zoom: 0.02
                }
            },
            tooltipDelay: 200,
            zoomView: true,
            dragView: true
        },
        layout: {
            improvedLayout: true
        },
        configure: {
            enabled: false
        }
    };

    // åˆ›å»ºç½‘ç»œ
    try {
        const data = { nodes, edges };
        graph = new vis.Network(container, data, options);

        // æ·»åŠ äº‹ä»¶ç›‘å¬
        graph.on('click', function(params) {
            if (params.nodes.length > 0) {
                const nodeId = params.nodes[0];
                if (nodeId !== 0) {
                    const skillIndex = nodeId - 1;
                    if (skillsData[skillIndex]) {
                        const skill = skillsData[skillIndex];
                        // å¯ä»¥åœ¨è¿™é‡Œæ˜¾ç¤ºæŠ€èƒ½è¯¦æƒ…
                        console.log(`ç‚¹å‡»æŠ€èƒ½: ${skill.skill}, æƒé‡: ${skill.weight}`);
                    }
                } else {
                    console.log(`ç‚¹å‡»å²—ä½: ${jobName}`);
                }
            }
        });

        // ç¨³å®šåŒ–å®Œæˆåè°ƒæ•´è§†å›¾
        graph.on('stabilizationIterationsDone', function() {
            graph.fit({
                animation: {
                    duration: 1500,
                    easingFunction: 'easeInOutQuad'
                }
            });
        });

        console.log('çŸ¥è¯†å›¾è°±ç”ŸæˆæˆåŠŸ');

    } catch (error) {
        console.error('çŸ¥è¯†å›¾è°±åˆå§‹åŒ–å¤±è´¥:', error);
        container.innerHTML = `
            <div style="
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                height: 100%;
                color: #666;
                text-align: center;
                padding: 20px;
            ">
                <div style="font-size: 48px; margin-bottom: 16px;">âš ï¸</div>
                <div style="font-size: 16px; margin-bottom: 8px; font-weight: 600;">çŸ¥è¯†å›¾è°±åŠ è½½å¤±è´¥</div>
                <div style="font-size: 14px; color: #94a3b8;">è¯·åˆ·æ–°é¡µé¢é‡è¯•</div>
                <div style="font-size: 12px; color: #cbd5e1; margin-top: 20px;">é”™è¯¯: ${error.message}</div>
            </div>
        `;
    }
}

// åˆ‡æ¢ç‰©ç†æ•ˆæœ
function togglePhysics() {
    if (!graph) return;

    physicsEnabled = !physicsEnabled;
    graph.setOptions({
        physics: {
            enabled: physicsEnabled
        }
    });

    // æ˜¾ç¤ºæç¤º
    const btn = document.querySelector('.graph-control-btn:nth-child(2)');
    if (btn) {
        btn.innerHTML = physicsEnabled ?
            '<span>âš™ï¸</span> å…³é—­ç‰©ç†æ•ˆæœ' :
            '<span>âš™ï¸</span> å¼€å¯ç‰©ç†æ•ˆæœ';
    }
}

// é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
document.addEventListener('DOMContentLoaded', function() {
    {% if selected_job and job_skills %}
        // è·å–æŠ€èƒ½æ•°æ®
        const skillsData = {{ job_skills|tojson|safe }};
        const jobName = "{{ selected_job.name }}";

        // ç”Ÿæˆè¯äº‘
        setTimeout(function() {
            generateWordCloud(skillsData);
        }, 100);

        // ç”ŸæˆçŸ¥è¯†å›¾è°±
        setTimeout(function() {
            generateKnowledgeGraph(skillsData, jobName);
        }, 200);

        // çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°ç”Ÿæˆè¯äº‘
        let resizeTimer;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function() {
                generateWordCloud(skillsData);

                // é‡æ–°é€‚åº”çŸ¥è¯†å›¾è°±è§†å›¾
                if (graph) {
                    setTimeout(() => {
                        graph.fit({
                            animation: {
                                duration: 1000,
                                easingFunction: 'easeInOutQuad'
                            }
                        });
                    }, 300);
                }
            }, 300);
        });
    {% endif %}
});
</script>
{% endif %}
{% endblock %}